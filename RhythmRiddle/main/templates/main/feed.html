{% extends 'main/layout.html' %}
{% load static %}
{% block extrastyles %}
    <link rel="stylesheet" href="{% static 'start/css/index.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/song_label.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/modal.css' %}">
{% endblock %}
{% block content %}
    <div>
        <section class="highlight">
            <div class="highlight-image">
                {% if song and song.cover %}
                    <img src="{{ song.cover.url }}" alt="Лучшее за этот месяц">
                {% else %}
                    <img src="{#}" alt="Нет изображения">
                {% endif %}
            </div>
            <div class="highlight-info">
                <h1>Лучшее за этот месяц</h1>
                <h2>{{ song.title|default:"Нет песни" }}</h2>
                <p>{{ song.artist|default:"Нет исполнителя" }}</p>
                <span class="popular-play-count">{{ song.play_count|default:0 }} прослушиваний</span>

                {% if song %}
                    <audio controls>
                        <source src="{{ song.file.url }}" type="audio/mpeg">
                        Ваш браузер не поддерживает аудио.
                    </audio>
                    <form action="{% url 'add_favorite' song.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="add-favorite-btn-2">Добавить в избранное</button>
                    </form>
                {% endif %}
            </div>
        </section>

    <section class="quick-picks">
        <div>
            {% if quick_picks %}
                <section class="quick-picks">
                    <h3>Быстрая выборка</h3>
                    <div class="song-list">
                        {% for song in quick_picks %}
                            <div class="song-item">
                                {% if song.cover %}
                                    <img src="{{ song.cover.url }}" alt="Обложка {{ song.title }}" class="song-cover">
                                {% endif %}
                                <div class="song-info">
                                    <h4>{{ song.title }}</h4>
                                    <span>{{ song.artist }}</span><br>
                                    <audio controls>
                                        <source src="{{ song.file.url }}" type="audio/mpeg">
                                    </audio>
                                    <form action="{% url 'add_favorite' song.id %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit" class="add-favorite-btn-2">Добавить в избранное</button>
                                    </form>
                                </div>
                            </div>
                        {% empty %}
                            <p>Нет доступных песен для выбора.</p>
                        {% endfor %}
                    </div>
                </section>
            {% else %}
                <p>Нет доступных песен.</p>
            {% endif %}
        </div>
    </section>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function() {
                $('.song-item audio').on('play', function() {
                    const songId = $(this).closest('.song-info').find('form').attr('action').split('/').slice(-2, -1)[0];

                    $.ajax({
                        url: "{% url 'increment_play_count' 0 %}".replace('0', songId),
                        method: 'POST',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                    });
                });

                $('audio').on('play', function() {
                    if ($(this).closest('.highlight-info').length > 0) {
                        const songId = "{{ song.id }}";

                        $.ajax({
                            url: "{% url 'increment_play_count' 0 %}".replace('0', songId),
                            method: 'POST',
                            data: {
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                        });
                    }
                });
            });
        </script>

        {% if stats.first_user_genre is None %}
            <div id="genreModal" class="modal">
                <div class="modal-content">
                    <h2>Выберите жанр</h2>
                    <p>Выберите хотя бы один жанр. Максимум можно выбрать три.</p>
                    <div id="genreSelection">
                        {% for genre, genre_display in stats.USERS_GENRE %}
                            <div class="genre-placeholder" data-genre="{{ genre }}">{{ genre_display }}</div>
                        {% endfor %}
                    </div>
                    <button id="doneButton">Готово</button>
                </div>
            </div>

            <script>
                document.getElementById('genreModal').style.display = "block";

                let selectedGenres = [];

                document.querySelectorAll('.genre-placeholder').forEach(function(element) {
                    element.addEventListener('click', function() {
                        const genre = this.getAttribute('data-genre');
                        if (selectedGenres.includes(genre)) {
                            selectedGenres = selectedGenres.filter(item => item !== genre);
                            this.classList.remove('selected');
                        } else {
                            if (selectedGenres.length < 3) {
                                selectedGenres.push(genre);
                                this.classList.add('selected');
                            }
                        }
                    });
                });

                document.getElementById('doneButton').addEventListener('click', function() {
                    const csrftoken = '{{ csrf_token }}';
                    fetch('{% url "update_genres" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ genres: selectedGenres })
                    }).then(() => location.reload());
                });
            </script>
        {% endif %}
    </div>
{% endblock %}
